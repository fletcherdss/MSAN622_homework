<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Stacked Area Chart</title>
    <script type="text/javascript" src="js/d3.min.js"></script>
    <script type="text/javascript" src="js/underscore-min.js"></script>
</head>

<style>

body {
  font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
  position: relative;
  width: 960px;
}

.axis { font: 13px sans-serif; }

.axis path,
.axis line {
  fill: #FFFFFF;
  stroke: black;
  shape-rendering: crispEdges;
}

.x.axis path {display: none;}
.y.axis path {display: black;}
.y.axis .tick line {stroke: lightgrey;}

.line {
  fill: none;
  stroke: steelblue;
  stroke-width: 2.5px;
}

label {
  position: absolute;
  top: 10px;
  right: 60px;
}

</style>

<body>

<label><input type="checkbox"> Center Groups</label>
<script>
 var margin = {top: 20, right: 20, bottom: 40, left: 80},
     width = 900 - margin.left - margin.right,
     height = 400 - margin.top - margin.bottom;

 function makeAxies(svg, x, y, ytext){
     
     var xAxis = d3.svg.axis().scale(x).orient("bottom").tickSize(6, 0 , 0);
     xAxis.tickFormat(d3.format("d"));
     var yAxis = d3.svg.axis().scale(y).orient("left").tickSize(6, 0, 0);
     
     var xax = svg.append("g").attr("class", "x axis")
                  .attr("transform", "translate(0," + height + ")")
	              .call(xAxis.ticks(15));
     
     xax.append("text")
	    .attr("y", 36)
	    .attr("x", width / 2 - 50)
	    .attr("dx", "0.71em")
	    .style("text-anchor", "end", " grid")
	    .text("page");
     
 };

</script>


<script>
 numPages = 180

 var data = [
     {"char":"green", "page":1},
     {"char":"green", "page":20},
     {"char":"red", "page":20},
     {"char":"brown", "page":40},
     {"char":"red", "page":60},
     {"char":"green", "page":100},
     {"char":"brown", "page":120},
     {"char":"pink", "page":140},
     {"char":"pink", "page":160},
     {"char":"green", "page":160} 
 ]

 var chars = _.unique(data.map(function (d) {return d.char;}))
 var sigPages = _.unique(data.map(function (d) {return d.page;}))
                 .sort(function (a, b) {return a - b;})

 function completePath(data) {
     filledPaths = {};
     chars.forEach(function(character) {
         var charData = data.filter(function(d) {return d.char == character;})
                            .sort(function(a, b) {return a.page - b.page;});
         console.log(charData);
         charData.forEach(function(d, i) {d.present = i % 2 == 0;})
         var filledPath = _.clone(sigPages);
         var i = 0;

         filledPath.forEach(function(page, j) {
             if (i >= charData.length)
                 p = false;
             else if (charData[i].page == page){
                 p = true; 
                 i++;
             }
             else
                 p = !charData[i].present;
             filledPath[j] = {"char":character, "page":page, "present":p};
         });

         filledPaths[character] = filledPath;
     });
     return filledPaths;
 };

 var paths = completePath(data);
 
 function transpose(a) {
     return _.zip.apply(_, a);
 } 

 var pageGroups = {}
 
 transpose(_.values(paths)).forEach(function(pageChars) {
     pagePresent = pageChars.filter(function(d) {return d.present;});
     if (pagePresent.length > 0)
         pageGroups[pagePresent[0].page] = pagePresent.map(function(d) {return d.char;});         
 });



 var svg = d3.select("body").append("svg")
	          .attr("width", width + margin.left + margin.right)
	          .attr("height", height + margin.top + margin.bottom)
	          .append("g")
	          .attr("transform",
                    "translate(" + (margin.left) + "," + (margin.top) + ")");

 var x = d3.scale.linear()
           .domain(d3.extent(data, function(d) {return d.page;}))
           .range([0,width]);
 
 var y = d3.scale.linear()
           .domain([0, chars.length + 1])
           .range([height, 0]);

 makeAxies(svg, x, y, "group");

 var color = d3.scale.category10()
               .domain(chars);

 
 function groupNumber(char, page, defaultGroup){
     group = pageGroups[page];
     if (_.contains(group, char)){
         if (defaultGroup >= 0)
             return defaultGroup;
         return d3.median(group.map(function (c) {return chars.indexOf(c) + 1;}));
     }
     return chars.indexOf(char) + 1;
 }



 d3.select("input").on("change", drawLines);
 drawLines()

 function drawLines() {
     var c = this.checked ? -1 : 0;

     ypos = function(d) {return y(groupNumber(d.char, d.page, c)) - 5 * chars.indexOf(d.char); }
     var line = d3.svg.line()
                  .x(function(d) { return x(d.page); })
                  .y(ypos)
                  .interpolate("monotone");
     
     chars.forEach(function(char) {
         lines = svg.select("." + char).datum(paths[char]);
         lines.remove();

         l = svg.append("g").attr("class", char).datum(paths[char]);
         l.append("path")
          .attr("class", "line")
          .attr("d", line)
          .style("stroke", function(d) { return char; });
//          .style("stroke-dasharray", function(d) { return  d.present ? none : [3,3]; });

         l.append("text")
	      .attr("y", ypos(paths[char][0]) + 3)
	      .attr("x", -20)
	      .attr("dx", "0.71em")
	      .style("text-anchor", "end")
          .attr("fill", char)
	      .text(char);

     });
  }

</script>


</body>
